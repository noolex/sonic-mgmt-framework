<?xml version="1.0" encoding="UTF-8"?>
<!--
Copyright 2019 Dell, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<CLISH_MODULE
    xmlns="http://www.dellemc.com/sonic/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xsi:schemaLocation="http://www.dellemc.com/sonic/XMLSchema
                        http://www.dellemc.com/sonic/XMLSchema/clish.xsd"
    >
    <VIEW name="enable-view">
        <!-- show ip pim -->
        <COMMAND hidden="true"
            name="show ip pim"
            help="Show PIM commands">
            <PARAM hidden="true"
                name="vrf"
                help="Show PIM information of the given VRF"
                mode="subcommand"
                optional="true"
                ptype="SUBCOMMAND">
                <PARAM hidden="true"
                  name="vrf-name"
                  help="Show PIM information of the given VRF"
                  mode="switch"
                  ptype="SUBCOMMAND">
                  <PARAM hidden="true"
                      name="vrf-name"
                      help="Name of VRF"
                      ptype="VRF_OR_DEFAULT">
                  </PARAM>
                  <PARAM hidden="true"
                      name="all"
                      help="All VRFs"
                      mode="subcommand"
                      ptype="SUBCOMMAND">
                  </PARAM>
                </PARAM>
            </PARAM>
            <PARAM hidden="true"
                name="filter"
                help="options: rpf, interface, neighbor, ssm, topology"
                mode="switch"
                order="true"
                ptype="SUBCOMMAND">

                <PARAM hidden="true"
                    name="interface"
                    help="Show interface details"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    optional="true">
                    <PARAM hidden="true"
                        name="iftype"
                        help="interface type"
                        mode="switch"
                        optional="true"
                        ptype="SUBCOMMAND">
                        <PARAM hidden="true"
                             name="port-id"
                             help="Physical interface"
                             ptype="PHY_INTERFACE">
                        </PARAM>
                        <PARAM hidden="true"
                            name="PortChannel"
                            help="PortChannel interface"
                            mode="subcommand"
                            ptype="SUBCOMMAND">
                            <PARAM hidden="true"
                                name="port-id"
                                help="PortChannel ID"
                                ptype="LAG_ID">
                            </PARAM>
                        </PARAM>
                        <PARAM hidden="true"
                            name="Vlan"
                            help="VLAN interface"
                            mode="subcommand"
                            ptype="SUBCOMMAND">
                            <PARAM hidden="true"
                                name="port-id"
                                help="VLAN ID"
                                ptype="VLAN_ID">
                            </PARAM>
                        </PARAM>
                    </PARAM>
                </PARAM>
                <PARAM hidden="true"
                    value="neighbor"
                    name="nbr"
                    help="Show PIM neighbor details"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    optional="true">
                    <PARAM hidden="true"
                        name="nbr-addr"
                        help="IPv4 address of the PIM neighbor"
                        optional="true"
                        ptype="IP_ADDR">
                    </PARAM>
                </PARAM>
                <PARAM hidden="true"
                    name="rpf"
                    help="Show RPF details"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    optional="true">
                </PARAM>
                <PARAM hidden="true"
                    name="ssm"
                    help="Show SSM details"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    optional="true">
                </PARAM>
                <PARAM hidden="true"
                    name="topology"
                    help="Show topology information"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    optional="true">
                    <PARAM hidden="true"
                        name="grp-addr"
                        help="IPv4 address of the group"
                        optional="true"
                        ptype="IP_ADDR">
                        <PARAM hidden="true"
                            name="src-addr"
                            help="IPv4 address of the source"
                            optional="true"
                            ptype="IP_ADDR">
                        </PARAM>
                    </PARAM>
                </PARAM>
            </PARAM>
            <ACTION builtin="clish_pyobj">sonic_cli_pim show_pim_config vrf:${vrf-name} ssm:${ssm} rpf:${rpf} topology:${topology} grpAddr:${grp-addr} srcAddr:${src-addr} nbr:${nbr} nbrAddr:${nbr-addr} intf:${interface} ifType:${iftype} port:${port-id}
            </ACTION>
            <DOCGEN>
                 <DESCRIPTION>
                    This command displays PIM table entries. Available options are:
                    interface, neighbor, ssm, topology and rpf. Results can also be filtered based on VRF name.
                </DESCRIPTION>

                <USAGE>
                   * show ip pim [vrf &lt;vrf-name&gt;] interface [&lt;intf-name&gt;]
                   * show ip pim [vrf &lt;vrf-name&gt;] neighbor [[&lt;nbr-ipv4-address&gt;]
                   * show ip pim [vrf &lt;vrf-name&gt;] ssm
                   * show ip pim [vrf &lt;vrf-name&gt;] topology [Group-addr | {Group-addr   Source-addr}]
                   * show ip pim [vrf &lt;vrf-name&gt;] rpf
                </USAGE>

                <EXAMPLE summary="show ip pim [vrf {&lt;vrf-name&gt; | all}] interface [&lt;intf-name&gt;]">
                    sonic # show ip pim interface
                    Interface       State       Address         PIM Nbrs       PIM DR          Hello-interval       PIM DR-Priority
                    Vlan100         up          100.0.0.2       1              100.0.0.2       30                   1
                    Vlan200         up          200.0.0.2       1              200.0.0.3       30                   1

                    ----------------------------------------------------------------------------------------------------------------

                    sonic # show ip pim interface vlan 100
                    Interface       State       Address         PIM Nbrs       PIM DR          Hello-interval       PIM DR-Priority
                    Vlan100         up          100.0.0.2       1              100.0.0.2       30                   1
                </EXAMPLE>

                <EXAMPLE summary="show ip pim [vrf {&lt;vrf-name&gt; | all}] neighbor [&lt;nbr-ipv4-address&gt;]">
                    sonic# show ip pim neighbor
                    Interface       Neighbor        Uptime         Expirytime       DR-Priority
                    Vlan100         100.0.0.1       01:38:52       00:01:22         1
                    Vlan200         200.0.0.3       01:22:33       00:01:13         1

                    --------------------------------------------------------------------------------

                    sonic# show ip pim neighbor 100.0.0.1
                    Interface       Neighbor        Uptime         Expirytime       DR-Priority
                    Vlan100         100.0.0.1       01:38:52       00:01:22         1
                </EXAMPLE>

                <EXAMPLE summary="show ip pim [vrf {&lt;vrf-name&gt; | all}] ssm">
                    If IP-prefix list is associated:
                    ===============================
                    sonic# show ip pim ssm
                    SSM group range : PIM_PLIST1

                    -----------------------------------------

                    If IP-prefix list is not associated:
                    ===================================
                    sonic# show ip pim ssm
                    SSM group range : 232.0.0.0/8
                </EXAMPLE>

                <EXAMPLE summary="show ip pim [vrf {&lt;vrf-name&gt; | all}] topology [Group-addr | {Group-addr Source-addr}]">
                    sonic# show ip pim topology
                    PIM Multicast Routing Table

                    (71.0.0.11, 233.0.0.1), uptime 13:08:24, expires 00:00:12
                      Incoming interface: vlan100, RPF neighbor 100.0.0.1
                      Outgoing interface list:
                        vlan200   uptime/expiry-time: 13:07:50/00:01:39
                        vlan122   uptime/expiry-time: 12:33:21/Never

                    (71.0.0.22, 233.0.0.1), uptime 13:08:45, expires 00:00:18
                      Incoming interface: vlan100, RPF neighbor 100.0.0.1
                      Outgoing interface list:
                        vlan200   uptime/expiry-time: 13:22:52/00:01:45
                        vlan124   uptime/expiry-time: 12:42:28/Never

                    (101.0.0.22, 225.1.1.1), uptime 13:07:51, expires 00:06:09
                      Incoming interface: vlan105, RPF neighbor 105.0.0.1
                      Outgoing interface list:
                        vlan200   uptime/expiry-time: 13:03:50/00:01:39
                        vlan123   uptime/expiry-time: 13:02:40/Never

                    --------------------------------------------------------------------------------

                    sonic# show ip pim topology 233.0.0.1
                    PIM Multicast Routing Table

                    (71.0.0.11, 233.0.0.1), uptime 13:08:24, expires 00:00:12
                      Incoming interface: vlan100, RPF neighbor 100.0.0.1
                      Outgoing interface list:
                        vlan200   uptime/expiry-time: 13:07:50/00:01:39
                        vlan122   uptime/expiry-time: 12:33:21/Never

                    (71.0.0.22, 233.0.0.1), uptime 13:08:45, expires 00:00:18
                      Incoming interface: vlan100, RPF neighbor 100.0.0.1
                      Outgoing interface list:
                        vlan200   uptime/expiry-time: 13:22:52/00:01:45
                        vlan124   uptime/expiry-time: 12:42:28/Never

                    --------------------------------------------------------------------------------

                    sonic# show ip pim topology 225.1.1.1 101.0.0.22
                    PIM Multicast Routing Table

                    (101.0.0.22, 225.1.1.1), uptime 13:07:51, expires 00:06:09
                      Incoming interface: vlan105, RPF neighbor 105.0.0.1
                      Outgoing interface list:
                        vlan200   uptime/expiry-time: 13:03:50/00:01:39
                        vlan123   uptime/expiry-time: 13:02:40/Never
                </EXAMPLE>

                <EXAMPLE summary="show ip pim [vrf {&lt;vrf-name&gt; | all}] rpf">
                    sonic# show ip pim rpf
                    Source          Group           RpfIface       RpfAddress       RibNextHop       Metric       Pref
                    71.0.0.11       233.0.0.1       Vlan100        100.0.0.1        100.0.0.1        0            1
                    71.0.0.22       235.0.0.1       Vlan100        100.0.0.1        100.0.0.1        0            1
                </EXAMPLE>
            </DOCGEN>
        </COMMAND>

  <!-- ============== -->
  <!-- Clear commands -->
  <!-- ============== -->
        <COMMAND hidden="true"
            name="clear ip pim"
            help="Clear PIM protocol information">
            <PARAM hidden="true"
                name="vrf"
                help="VRF instance information"
                mode="subcommand"
                optional="true"
                ptype="SUBCOMMAND">
                <PARAM hidden="true"
                    name="vrf-name"
                    help="Name of VRF"
                    ptype="VRF_OR_DEFAULT">
                </PARAM>
            </PARAM>
            <PARAM hidden="true"
                name="filter"
                help="options: interfaces, oil"
                mode="switch"
                order="true"
                ptype="SUBCOMMAND">
                <PARAM hidden="true"
                    name="interfaces"
                    help="Clear all PIM interfaces of a particular VRF"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    optional="true">
                </PARAM>
                <PARAM hidden="true"
                    name="oil"
                    help="Clear PIM OIL (Outgoing Interfaces List) of all multicast entries of a particular VRF"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    optional="true">
                </PARAM>
            </PARAM>
            <ACTION builtin="clish_pyobj">sonic_cli_pim clear_pim vrf:${vrf-name} interfaces:{interfaces} oil:${oil}
            </ACTION>
            <DOCGEN>
                <DESCRIPTION>
                    These commands are useful in debugging and resets the PIM interfaces and OIL (Outgoing Interfaces List).
                </DESCRIPTION>

                <USAGE>
                    * clear ip pim [vrf &lt;vrf-name&gt;] interfaces ==> To reset all PIM interfaces of a particular VRF
                    * clear ip pim [vrf &lt;vrf-name&gt;] oil ==> To rescan PIM OIL (Outgoing Interfaces List) of all multicast entries of a particular VRF
                </USAGE>

                <EXAMPLE summary="clear ip pim [vrf &lt;vrf-name&gt; ] interfaces">
                    sonic# clear ip pim interfaces
                    sonic#
                    ---------------------------------------
                    sonic# clear ip pim vrf Vrf2 interfaces
                    sonic#
                </EXAMPLE>
                <EXAMPLE summary="clear ip pim [vrf &lt;vrf-name&gt; ] oil">
                    sonic# clear ip pim oil
                    sonic#
                    ---------------------------------------
                    sonic# clear ip pim vrf Vrf2 oil
                    sonic#
                </EXAMPLE>
            </DOCGEN>
        </COMMAND>
    </VIEW>

    <!-- ============= -->
    <!-- Global Config -->
    <!-- ============= -->
    <VIEW name="configure-view">
        <COMMAND hidden="true"
            name="ip pim"
            command_tables="sonic-pim:sonic-pim/PIM_GLOBALS/PIM_GLOBALS_LIST/vrf-name={vrf_name},address-family={address-family}"
            command_keys="address-family=ipv4"
            render_command_cb="pim_ipv4_gbl"
            help="Configure PIM">
            <PARAM hidden="true"
                name="vrf"
                help="VRF Instance"
                mode="subcommand"
                optional="true"
                ptype="SUBCOMMAND">
                <PARAM hidden="true"
                    name="vrf-name"
                    help="Name of VRF"
                    ptype="VRF_OR_DEFAULT"></PARAM>
            </PARAM>
            <PARAM hidden="true"
                name="filter"
                help="Pick one command among following options"
                mode="switch"
                order="true"
                ptype="SUBCOMMAND">
                <PARAM hidden="true"
                    name="ecmp"
                    help="Enable ECMP"
                    ptype="SUBCOMMAND"
                    mode="subcommand">
                    <PARAM hidden="true"
                        name="rebalance"
                        help="Enable ECMP rebalance"
                        ptype="SUBCOMMAND"
                        optional="true"
                        mode="subcommand"></PARAM>
                </PARAM>
                <PARAM hidden="true"
                    name="join-prune-interval"
                    help="Join Prune interval"
                    ptype="SUBCOMMAND"
                    mode="subcommand">
                    <PARAM hidden="true"
                        help="Join Prune interval in seconds"
                        name="jpi"
                        ptype="RANGE_60_600"></PARAM>
                </PARAM>
                <PARAM hidden="true"
                    name="keep-alive-timer"
                    help="Keep Alive timer"
                    ptype="SUBCOMMAND"
                    mode="subcommand">
                    <PARAM hidden="true"
                        help="Keep Alive timer in seconds"
                        name="kat"
                        ptype="RANGE_31_60000"></PARAM>
                </PARAM>
                <PARAM hidden="true"
                    name="ssm"
                    help="Configure SSM"
                    ptype="SUBCOMMAND"
                    mode="subcommand">
                    <PARAM hidden="true"
                        name="prefix-list"
                        help="Configure SSM prefix list"
                        ptype="SUBCOMMAND"
                        mode="subcommand">
                        <PARAM hidden="true"
                            help="Name of a prefix list"
                            name="pln"
                            ptype="STRING"></PARAM>
                    </PARAM>
                </PARAM>
            </PARAM>
            <ACTION builtin="clish_pyobj">
                sonic_cli_pim patch_pim_global_config vrf:${vrf-name} jpi:${jpi} kat:${kat} pln:${pln} ecmp:${ecmp} rebalance:${rebalance} 2>/dev/stdout
            </ACTION>
            <DOCGEN>
                <DESCRIPTION>
                    The following PIM-SSM (IPv4) global configurations are
                    executed in configuration-view. All these commands can be executed per VRF. If
                    VRF is not specified, then it will be executed in "default" VRF context. Once
                    PIM global configurations are done on a particular non-default VRF, that VRF
                    cannot be deleted from the system till relevant PIM configurations are cleared.
                </DESCRIPTION>

                <USAGE>
                    ip pim [vrf &lt;vrf-name&gt;] join-prune-interval &lt;value : (60-600 seconds)&gt;
                    no ip pim [vrf &lt;vrf-name&gt;] join-prune-interval
                    ip pim [vrf &lt;vrf-name&gt;] keep-alive-timer &lt;value : (31-60000 seconds)&gt;
                    no ip pim [vrf &lt;vrf-name&gt;] keep-alive-timer
                    ip pim [vrf &lt;vrf-name&gt;] ssm prefix-list &lt;prefix-list-name&gt;
                    no ip pim [vrf &lt;vrf-name&gt;] ssm prefix-list
                    ip pim [vrf &lt;vrf-name&gt;] ecmp [rebalance]
                    no ip pim [vrf &lt;vrf-name&gt;] ecmp [rebalance]
                </USAGE>
                <EXAMPLE summary="List of PIM global and interface level commands">
                sonic# configure terminal
                sonic(config)#

                sonic(config)# ip pim
                  vrf                  VRF name
                  join-prune-interval  Join prune interval in seconds
                  keep-alive-timer     Keep alive timer in seconds
                  ssm                  Configure SSM mode
                  ecmp                 Configure ECMP

                sonic(config)# ip pim vrf Vrf1
                  join-prune-interval  Join prune interval in seconds
                  keep-alive-timer     Keep alive timer in seconds
                  ssm                  Configure SSM mode
                  ecmp                 Configure ECMP

                sonic(config)# no ip pim
                  vrf                  VRF name
                  join-prune-interval  Join prune interval in seconds
                  keep-alive-timer     Keep alive timer in seconds
                  ssm                  Configure SSM mode
                  ecmp                 Configure ECMP mode

                sonic(config)# no ip pim vrf Vrf1
                  join-prune-interval  Join prune interval in seconds
                  keep-alive-timer     Keep alive timer in seconds
                  ssm                  Configure SSM mode
                  ecmp                 Configure ECMP mode
                </EXAMPLE>


                <EXAMPLE summary="ip pim [vrf &lt;vrf-name&gt;] join-prune-interval &lt;value : (60-600 seconds)&gt;">
                  sonic(config)# ip pim join-prune-interval
                        &lt;0..600&gt;  Range 60-600 seconds
                    -------------------------------------------------------
                    sonic(config)# ip pim join-prune-interval 70
                    sonic(config)#
                    -------------------------------------------------------
                    sonic(config)# ip pim vrf Vrf1 join-prune-interval 75
                    sonic(config)#
                </EXAMPLE>

                <EXAMPLE summary="ip pim [vrf &lt;vrf-name&gt;] keep-alive-timer &lt;value : (31-60000 seconds)&gt;">
                    sonic(config)# ip pim keep-alive-timer
                        &lt;31..60000&gt;  Range 31-60000 seconds
                    sonic(config)#

                    sonic(config)# ip pim keep-alive-timer 35
                    sonic(config)# ip pim vrf Vrf1 keep-alive-timer 45
                    sonic(config)#
                </EXAMPLE>

                <EXAMPLE summary="ip pim [vrf &lt;vrf-name&gt;] ssm prefix-list &lt;vrefix-list-name&gt;">
                    sonic(config)# ip pim ssm
                      prefix-list  Configure prefix list name

                    sonic(config)# ip pim ssm prefix-list
                      String  Prefix list name

                    sonic(config)# ip pim ssm prefix-list pim_ssm_pfx_list
                    sonic(config)# ip pim vrf Vrf1 ssm prefix-list pim_ssm_pfx_list
                    sonic(config)#
                </EXAMPLE>

                <EXAMPLE summary="ip pim ecmp">
                    sonic(config)# ip pim ecmp
                    sonic(config)# ip pim vrf Vrf1 ecmp
                    sonic(config)#
                </EXAMPLE>

                <EXAMPLE summary="ip pim ecmp rebalance">
                    sonic(config)# ip pim ecmp rebalance
                    sonic(config)# ip pim vrf Vrf1 ecmp rebalance
                    sonic(config)#
                </EXAMPLE>
            </DOCGEN>
        </COMMAND>

        <!-- no ip pim -->
        <COMMAND hidden="true"
            name="no ip pim"
            help="Delete PIM configuration">
            <PARAM hidden="true"
                name="vrf"
                help="VRF Instance"
                mode="subcommand"
                ptype="SUBCOMMAND"
                optional="true">
                <PARAM hidden="true"
                    name="vrf-name"
                    help="Name of VRF"
                    ptype="VRF_OR_DEFAULT"></PARAM>
            </PARAM>
            <PARAM hidden="true"
                name="filter"
                help="Pick one command among following options"
                mode="switch"
                order="true"
                ptype="SUBCOMMAND">
                <PARAM hidden="true"
                    name="ecmp"
                    help="Disable ECMP"
                    ptype="SUBCOMMAND"
                    mode="subcommand">
                    <PARAM hidden="true"
                        name="rebalance"
                        help="Disable ECMP rebalance"
                        ptype="SUBCOMMAND"
                        optional="true"
                        mode="subcommand"></PARAM>
                </PARAM>
                <PARAM hidden="true"
                    name="jpi"
                    value="join-prune-interval"
                    help="Clear Join Prune interval"
                    ptype="SUBCOMMAND"
                    mode="subcommand">
                </PARAM>
                <PARAM hidden="true"
                    name="kat"
                    value="keep-alive-timer"
                    help="Clear Keep Alive timer"
                    ptype="SUBCOMMAND"
                    mode="subcommand">
                </PARAM>
                <PARAM hidden="true"
                    name="ssm"
                    help="Remove SSM configuration"
                    ptype="SUBCOMMAND"
                    mode="subcommand">
                    <PARAM hidden="true"
                        name="pln"
                        value="prefix-list"
                        help="Remove SSM prefix list"
                        ptype="SUBCOMMAND"
                        mode="subcommand">
                    </PARAM>
                </PARAM>
            </PARAM>
            <ACTION builtin="clish_pyobj">
                sonic_cli_pim del_pim_global_config vrf:${vrf-name} jpi:${jpi} kat:${kat} pln:${pln} ecmp:${ecmp} rebalance:${rebalance} 2>/dev/stdout
            </ACTION>
            <DOCGEN>
                <DESCRIPTION>
                    These commands undo the changes made by the config command.
                </DESCRIPTION>

                <USAGE>
                    no ip pim [vrf &lt;vrf-name&gt;] join-prune-interval
                    no ip pim [vrf &lt;vrf-name&gt;] keep-alive-timer
                    no ip pim [vrf &lt;vrf-name&gt;] ssm prefix-list
                    no ip pim [vrf &lt;vrf-name&gt;] ecmp [rebalance]
                </USAGE>

                <EXAMPLE summary="no ip pim join-prune-interval">
                    sonic(config)# no ip pim join-prune-interval
                    sonic(config)# no ip pim vrf Vrf1 join-prune-interval
                </EXAMPLE>

                <EXAMPLE summary="no ip pim keep-alive-timer">
                    sonic(config)# no ip pim keep-alive-timer
                    sonic(config)# no ip pim vrf Vrf1 keep-alive-timer
                    sonic(config)#
                </EXAMPLE>

                <EXAMPLE summary="no ip pim ssm prefix-list">
                    sonic(config)# no ip pim ssm prefix-list
                    sonic(config)# no ip pim vrf Vrf1 ssm prefix-list
                    sonic(config)#
                </EXAMPLE>

                <EXAMPLE summary="no ip pim ecmp">
                    sonic(config)# no ip pim ecmp
                    sonic(config)# no ip pim vrf Vrf1 ecmp
                    sonic(config)#
                </EXAMPLE>

                <EXAMPLE summary="no ip pim ecmp rebalance">
                    sonic(config)# no ip pim ecmp rebalance
                    sonic(config)# no ip pim vrf Vrf1 ecmp rebalance
                    sonic(config)#
                </EXAMPLE>
            </DOCGEN>
        </COMMAND>
    </VIEW>

    <!-- =============== -->
    <!-- Ethernet Config -->
    <!-- =============== -->
    <VIEW name="configure-if-view">
        <MACRO name="BIND-INTF-TO-PIM" arg="${iface_uri}"></MACRO>
    </VIEW>

    <!-- ================== -->
    <!-- PortChannel Config -->
    <!-- ================== -->
    <VIEW name="configure-lag-view">
        <MACRO name="BIND-INTF-TO-PIM" arg="${po_name}"></MACRO>
    </VIEW>

    <!-- =========== -->
    <!-- VLAN Config -->
    <!-- =========== -->
    <VIEW name="configure-vlan-view">
        <MACRO name="BIND-INTF-TO-PIM" arg="${vlan_name}"></MACRO>
    </VIEW>

</CLISH_MODULE>
